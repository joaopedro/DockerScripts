/**
 * Copyright 2012 Jeanfrancois Arcand
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
jQuery.atmosphere=function(){jQuery(window).bind("unload.atmosphere",function(){jQuery.atmosphere.unsubscribe()});jQuery(window).bind("offline",function(){jQuery.atmosphere.unsubscribe()});jQuery(window).keypress(function(d){27===d.keyCode&&d.preventDefault()});var s=function(d){for(var g,h=/^(.*?):[ \t]*([^\r\n]*)\r?$/mg,m={};g=h.exec(d);)m[g[1]]=g[2];return m};return{version:"2.0.0-jquery",requests:[],callbacks:[],onError:function(d){},onClose:function(d){},onOpen:function(d){},onMessage:function(d){}, onReconnect:function(d,g){},onMessagePublished:function(d){},onTransportFailure:function(d,g){},onLocalMessage:function(d){},onFailureToReconnect:function(d,g){},AtmosphereRequest:function(d){function g(b){n();T=!0;H=!1;B=0;t=K=y=l=null;c=jQuery.extend(c,b);c.mrequest=c.reconnect;c.reconnect||(c.reconnect=!0)}function h(){if(c.shared){v=m(c);if(null!=v&&("debug"===c.logLevel&&jQuery.atmosphere.debug("Storage service available. All communication will be local"),v.open(c)))return;"debug"===c.logLevel&& jQuery.atmosphere.debug("No Storage service available.");v=null}c.firstMessage=!0;c.isOpen=!1;c.ctime=jQuery.now();"websocket"!==c.transport&&"sse"!==c.transport?U(c):"websocket"===c.transport?null!=c.webSocketImpl||window.WebSocket||window.MozWebSocket?k(!1):L("Websocket is not supported, using request.fallbackTransport ("+c.fallbackTransport+")"):"sse"===c.transport&&(window.EventSource?w(!1):L("Server Side Events(SSE) is not supported, using request.fallbackTransport ("+c.fallbackTransport+")"))} function m(b){function a(a){a=jQuery.parseJSON(a);var f=a.data;if("c"===a.target)switch(a.type){case "open":q("opening","local",c);break;case "close":V||(V=!0,"aborted"===f.reason?N():f.heir===E?h():setTimeout(function(){h()},100));break;case "message":F(f,"messageReceived",200,b.transport);break;case "localMessage":$(f)}}function e(){var a=RegExp("(?:^|; )("+encodeURIComponent(g)+")=([^;]*)").exec(document.cookie);if(a)return jQuery.parseJSON(decodeURIComponent(a[2]))}var f,d,V,g="atmosphere-"+b.url, aa={storage:function(){if(jQuery.atmosphere.supportStorage()){var c=window.localStorage,f=function(a){return jQuery.parseJSON(c.getItem(g+"-"+a))},e=function(a,b){c.setItem(g+"-"+a,jQuery.stringifyJSON(b))};return{init:function(){e("children",f("children").concat([E]));jQuery(window).on("storage.socket",function(b){b=b.originalEvent;b.key===g&&b.newValue&&a(b.newValue)});return f("opened")},signal:function(a,b){c.setItem(g,jQuery.stringifyJSON({target:"p",type:a,data:b}))},close:function(){var a, c=f("children");jQuery(window).off("storage.socket");c&&(a=jQuery.inArray(b.id,c),-1<a&&(c.splice(a,1),e("children",c)))}}}},windowref:function(){var b=window.open("",g.replace(/\W/g,""));if(b&&!b.closed&&b.callbacks)return{init:function(){b.callbacks.push(a);b.children.push(E);return b.opened},signal:function(a,c){!b.closed&&b.fire&&b.fire(jQuery.stringifyJSON({target:"p",type:a,data:c}))},close:function(){if(!V){var c=b.callbacks,f=jQuery.inArray(a,c);-1<f&&c.splice(f,1);c=b.children;f=jQuery.inArray(E, c);-1<f&&c.splice(f,1)}}}}};if((f=e())&&!(1E3<jQuery.now()-f.ts)&&(d=aa.storage()||aa.windowref()))return{open:function(){var c;O=setInterval(function(){var b=f;(f=e())&&b.ts!==f.ts||a(jQuery.stringifyJSON({target:"c",type:"close",data:{reason:"error",heir:b.heir}}))},1E3);(c=d.init())&&setTimeout(function(){q("opening","local",b)},50);return c},send:function(a){d.signal("send",a)},localSend:function(a){d.signal("localSend",jQuery.stringifyJSON({id:E,event:a}))},close:function(){H||(clearInterval(O), d.signal("close"),d.close())}}}function r(){function b(a){a=jQuery.parseJSON(a);var b=a.data;if("p"===a.target)switch(a.type){case "send":W(b);break;case "localSend":$(b);break;case "close":N()}}function a(){document.cookie=encodeURIComponent(f)+"="+encodeURIComponent(jQuery.stringifyJSON({ts:jQuery.now()+1,heir:(e.get("children")||[])[0]}))}var e,f="atmosphere-"+c.url,d={storage:function(){if(jQuery.atmosphere.supportStorage()){var a=window.localStorage;return{init:function(){jQuery(window).on("storage.socket", function(a){a=a.originalEvent;a.key===f&&a.newValue&&b(a.newValue)})},signal:function(b,c){a.setItem(f,jQuery.stringifyJSON({target:"c",type:b,data:c}))},get:function(b){return jQuery.parseJSON(a.getItem(f+"-"+b))},set:function(b,c){a.setItem(f+"-"+b,jQuery.stringifyJSON(c))},close:function(){jQuery(window).off("storage.socket");a.removeItem(f);a.removeItem(f+"-opened");a.removeItem(f+"-children")}}}},windowref:function(){var a=f.replace(/\W/g,""),c=(jQuery('iframe[name="'+a+'"]')[0]||jQuery('<iframe name="'+ a+'" />').hide().appendTo("body")[0]).contentWindow;return{init:function(){c.callbacks=[b];c.fire=function(a){var b;for(b=0;b<c.callbacks.length;b++)c.callbacks[b](a)}},signal:function(a,b){!c.closed&&c.fire&&c.fire(jQuery.stringifyJSON({target:"c",type:a,data:b}))},get:function(a){return c.closed?null:c[a]},set:function(a,b){c.closed||(c[a]=b)},close:function(){}}}};M=function(a){e.signal("message",a)};e=d.storage()||d.windowref();e.init();"debug"===c.logLevel&&jQuery.atmosphere.debug("Installed StorageService "+ e);e.set("children",[]);null==e.get("opened")||e.get("opened")||e.set("opened",!1);a();O=setInterval(a,1E3);C=e}function q(b,a,p){c.shared&&"local"!==a&&r();null!=C&&C.set("opened",!0);p.close=function(){N()};0<B&&"re-connecting"===b?(p.isReopen=!0,ja(e)):null==e.error&&(e.request=p,p=e.state,e.state=b,b=e.transport,e.transport=a,a=e.responseBody,z(),e.responseBody=a,e.state=p,e.transport=b)}function ba(b){b.transport="jsonp";var a=c;null!=b&&"undefined"!==typeof b&&(a=b);b=a.url;null!=a.dispatchUrl&& (b+=a.dispatchUrl);var p=a.data;a.attachHeadersAsQueryString&&(b=I(a),""!==p&&(b+="&X-Atmosphere-Post-Body="+encodeURIComponent(p)),p="");u=jQuery.ajax({url:b,type:a.method,dataType:"jsonp",error:function(b,c,p){e.error=!0;300>b.status?A(u,a,0):x(b.status,p)},jsonp:"jsonpTransport",success:function(b){if(a.reconnect)if(-1===a.maxRequest||a.requestCount++<a.maxRequest){P(u,a);a.executeCallbackBeforeReconnect||A(u,a,0);b=b.message;if(null!=b&&"string"!==typeof b)try{b=jQuery.stringifyJSON(b)}catch(p){}D(b, a,e)||F(e.responseBody,"messageReceived",200,a.transport);a.executeCallbackBeforeReconnect&&A(u,a,0)}else jQuery.atmosphere.log(c.logLevel,["JSONP reconnect maximum try reached "+c.requestCount]),x(0,"maxRequest reached")},data:a.data,beforeSend:function(b){X(b,a,!1)}})}function ka(b){var a=c;null!=b&&"undefined"!==typeof b&&(a=b);b=a.url;null!=a.dispatchUrl&&(b+=a.dispatchUrl);var p=a.data;a.attachHeadersAsQueryString&&(b=I(a),""!==p&&(b+="&X-Atmosphere-Post-Body="+encodeURIComponent(p)),p="");u= jQuery.ajax({url:b,type:a.method,error:function(b,c,p){e.error=!0;300>b.status?A(u,a):x(b.status,p)},success:function(b,p,d){a.reconnect&&(-1===a.maxRequest||a.requestCount++<a.maxRequest?(a.executeCallbackBeforeReconnect||A(u,a,0),D(b,a,e)||F(e.responseBody,"messageReceived",200,a.transport),a.executeCallbackBeforeReconnect&&A(u,a,0)):(jQuery.atmosphere.log(c.logLevel,["AJAX reconnect maximum try reached "+c.requestCount]),x(0,"maxRequest reached")))},beforeSend:function(b){X(b,a,!1)},crossDomain:a.enableXDR, async:"undefined"!==typeof a.async?a.async:!0})}function la(){var b=I(c);return decodeURI(jQuery('<a href="'+b+'"/>')[0].href.replace(/^http/,"ws"))}function w(b){e.transport="sse";var a=I(c);"debug"===c.logLevel&&(jQuery.atmosphere.debug("Invoking executeSSE"),jQuery.atmosphere.debug("Using URL: "+a));if(c.enableProtocol&&b){var p=jQuery.now()-c.ctime;c.lastTimestamp=Number(c.stime)+Number(p)}if(b&&!c.reconnect)null!=y&&n();else{try{y=new EventSource(a,{withCredentials:c.withCredentials})}catch(f){x(0, f);L("SSE failed. Downgrading to fallback transport and resending");return}0<c.connectTimeout&&(c.id=setTimeout(function(){b||n()},c.connectTimeout));y.onopen=function(a){G(c);"debug"===c.logLevel&&jQuery.atmosphere.debug("SSE successfully opened");c.enableProtocol||(b?q("re-opening","sse",c):q("opening","sse",c));b=!0;"POST"===c.method&&(e.state="messageReceived",y.send(c.data))};y.onmessage=function(a){G(c);c.enableXDR||a.origin===window.location.protocol+"//"+window.location.host?(e.state="messageReceived", e.status=200,a=a.data,D(a,c,e)||(z(),e.responseBody="",e.messages=[])):jQuery.atmosphere.log(c.logLevel,["Origin was not "+window.location.protocol+"//"+window.location.host])};y.onerror=function(a){clearTimeout(c.id);J(b);n();H?jQuery.atmosphere.log(c.logLevel,["SSE closed normally"]):b?c.reconnect&&"sse"===e.transport&&(B++<c.maxReconnectOnClose?(q("re-connecting",c.transport,c),c.id=setTimeout(function(){w(!0)},c.reconnectInterval),e.responseBody="",e.messages=[]):(jQuery.atmosphere.log(c.logLevel, ["SSE reconnect maximum try reached "+B]),x(0,"maxReconnectOnClose reached"))):L("SSE failed. Downgrading to fallback transport and resending")}}}function k(b){e.transport="websocket";if(c.enableProtocol&&b){var a=jQuery.now()-c.ctime;c.lastTimestamp=Number(c.stime)+Number(a)}a=la(c.url);"debug"===c.logLevel&&(jQuery.atmosphere.debug("Invoking executeWebSocket"),jQuery.atmosphere.debug("Using URL: "+a));if(b&&!c.reconnect)null!=l&&n();else if(l=null!=c.webSocketImpl?c.webSocketImpl:window.WebSocket? new WebSocket(a):new MozWebSocket(a),null!=c.webSocketBinaryType&&(l.binaryType=c.webSocketBinaryType),0<c.connectTimeout&&(c.id=setTimeout(function(){if(!b){l.onclose({code:1002,reason:"",wasClean:!1});try{n()}catch(a){}}},c.connectTimeout)),l.onopen=function(a){G(c);"debug"===c.logLevel&&jQuery.atmosphere.debug("Websocket successfully opened");c.enableProtocol||(b?q("re-opening","websocket",c):q("opening","websocket",c));b=!0;l.webSocketOpened=b;"POST"===c.method&&(e.state="messageReceived",l.send(c.data))}, l.onmessage=function(a){G(c);e.state="messageReceived";e.status=200;a=a.data;"string"===typeof a?D(a,c,e)||(z(),e.responseBody="",e.messages=[]):ca(c,a)&&(e.responseBody=a,z(),e.responseBody=null)},l.onerror=function(a){clearTimeout(c.id)},l.onclose=function(a){if("closed"!==e.state){clearTimeout(c.id);var f=a.reason;if(""===f)switch(a.code){case 1E3:f="Normal closure; the connection successfully completed whatever purpose for which it was created.";break;case 1001:f="The endpoint is going away, either because of a server failure or because the browser is navigating away from the page that opened the connection."; break;case 1002:f="The endpoint is terminating the connection due to a protocol error.";break;case 1003:f="The connection is being terminated because the endpoint received data of a type it cannot accept (for example, a text-only endpoint received binary data).";break;case 1004:f="The endpoint is terminating the connection because a data frame was received that is too large.";break;case 1005:f="Unknown: no status code was provided even though one was expected.";break;case 1006:f="Connection was closed abnormally (that is, with no close frame being sent)."}jQuery.atmosphere.warn("Websocket closed, reason: "+ f);jQuery.atmosphere.warn("Websocket closed, wasClean: "+a.wasClean);J(b);e.state="closed";H?jQuery.atmosphere.log(c.logLevel,["Websocket closed normally"]):b?c.reconnect&&"websocket"===e.transport&&(n(),B++<c.maxReconnectOnClose?(q("re-connecting",c.transport,c),c.id=setTimeout(function(){e.responseBody="";e.messages=[];k(!0)},c.reconnectInterval)):(jQuery.atmosphere.log(c.logLevel,["Websocket reconnect maximum try reached "+c.requestCount]),jQuery.atmosphere.warn("Websocket error, reason: "+a.reason), x(0,"maxReconnectOnClose reached"))):L("Websocket failed. Downgrading to Comet and resending")}},void 0===l.url)l.onclose({reason:"Android 4.1 does not support websockets.",wasClean:!1})}function ca(b,a){var c=!0;if(0!==jQuery.trim(a)&&b.enableProtocol&&b.firstMessage){b.firstMessage=!1;var c=a.split(b.messageDelimiter),e=2===c.length?0:1;b.uuid=jQuery.trim(c[e]);b.stime=jQuery.trim(c[e+1]);c=!1;"long-polling"!==b.transport&&Y(b)}else Y(b);return c}function G(b){clearTimeout(b.id);0<b.timeout&&"polling"!== b.transport&&(b.id=setTimeout(function(){J(!0);n();Q()},b.timeout))}function x(b,a){n();clearTimeout(c.id);e.state="error";e.reasonPhrase=a;e.responseBody="";e.status=b;e.messages=[];z()}function D(b,a,e){if(!ca(c,b)||0===b.length)return!0;if(a.trackMessageLength){b=e.partialMessage+b;for(var f=[],d=b.indexOf(a.messageDelimiter);-1!==d;){var g=jQuery.trim(b.substring(0,d)),h=parseInt(g,10);if(isNaN(h))throw'message length "'+g+'" is not a number';d+=a.messageDelimiter.length;d+h>b.length?d=-1:(f.push(b.substring(d, d+h)),b=b.substring(d+h,b.length),d=b.indexOf(a.messageDelimiter))}e.partialMessage=b;if(0!==f.length)e.responseBody=f.join(a.messageDelimiter),e.messages=f;else return e.responseBody="",e.messages=[],!0}else e.responseBody=b;return!1}function L(b){jQuery.atmosphere.log(c.logLevel,[b]);if("undefined"!==typeof c.onTransportFailure)c.onTransportFailure(b,c);else if("undefined"!==typeof jQuery.atmosphere.onTransportFailure)jQuery.atmosphere.onTransportFailure(b,c);c.transport=c.fallbackTransport;b=-1=== c.connectTimeout?0:c.connectTimeout;c.reconnect&&"none"!==c.transport||null==c.transport?(c.method=c.fallbackMethod,e.transport=c.fallbackTransport,c.fallbackTransport="none",c.id=setTimeout(function(){h()},b)):x(500,"Unable to reconnect with fallback transport")}function I(b,a){var d=c;null!=b&&"undefined"!==typeof b&&(d=b);null==a&&(a=d.url);if(!d.attachHeadersAsQueryString||-1!==a.indexOf("X-Atmosphere-Framework"))return a;a+=-1!==a.indexOf("?")?"&":"?";a+="X-Atmosphere-tracking-id="+d.uuid;a+= "&X-Atmosphere-Framework="+jQuery.atmosphere.version;a+="&X-Atmosphere-Transport="+d.transport;d.trackMessageLength&&(a+="&X-Atmosphere-TrackMessageSize=true");a=null!=d.lastTimestamp?a+("&X-Cache-Date="+d.lastTimestamp):a+"&X-Cache-Date=0";""!==d.contentType&&(a+="&Content-Type="+d.contentType);d.enableProtocol&&(a+="&X-atmo-protocol=true");jQuery.each(d.headers,function(c,g){var h=jQuery.isFunction(g)?g.call(this,d,b,e):g;null!=h&&(a+="&"+encodeURIComponent(c)+"="+encodeURIComponent(h))});return a} function Y(b){b.isOpen?b.isReopen&&(b.isReopen=!1,q("re-opening",b.transport,b)):(b.isOpen=!0,q("opening",b.transport,b))}function U(b){var a=c;if(null!=b||"undefined"!==typeof b)a=b;a.lastIndex=0;a.readyState=0;if("jsonp"===a.transport||a.enableXDR&&jQuery.atmosphere.checkCORSSupport())ba(a);else if("ajax"===a.transport)ka(b);else{if(jQuery.browser.msie&&10>jQuery.browser.version){if("streaming"===a.transport){a.enableXDR&&window.XDomainRequest?R(a):(t=Z(a),t.open());return}if(a.enableXDR&&window.XDomainRequest){R(a); return}}var d=function(){a.lastIndex=0;a.reconnect&&B++<a.maxReconnectOnClose?(q("re-connecting",b.transport,b),A(f,a,b.reconnectInterval)):x(0,"maxReconnectOnClose reached")};if(a.reconnect&&(-1===a.maxRequest||a.requestCount++<a.maxRequest)){var f=jQuery.ajaxSettings.xhr();f.hasData=!1;X(f,a,!0);a.suspend&&(K=f);"polling"!==a.transport&&(e.transport=a.transport,f.onabort=function(){J(!0)},f.onerror=function(){e.error=!0;try{e.status=XMLHttpRequest.status}catch(a){e.status=500}e.status||(e.status= 500);n();e.errorHandled||d()});f.onreadystatechange=function(){if(!H){e.error=null;var g=!1,h=!1;if(jQuery.browser.opera&&"streaming"===a.transport&&2<a.readyState&&4===f.readyState)n(),d();else if(a.readyState=f.readyState,"streaming"===a.transport&&3<=f.readyState?h=!0:"long-polling"===a.transport&&4===f.readyState&&(h=!0),G(c),a.enableProtocol&&b.firstMessage||("polling"===a.transport||2!==f.readyState)||Y(a),h)if(h=0,0!==f.readyState&&(h=1E3<f.status?0:f.status),300<=h||0===h)e.errorHandled=!0, n(),d();else if(h=f.responseText,0===jQuery.trim(h.length)&&"long-polling"===a.transport)f.hasData?f.hasData=!1:d();else{f.hasData=!0;P(f,c);if("streaming"===a.transport)if(jQuery.browser.opera)jQuery.atmosphere.iterate(function(){if(500!==e.status&&f.responseText.length>a.lastIndex){try{e.status=f.status,e.headers=s(f.getAllResponseHeaders()),P(f,c)}catch(b){e.status=404}G(c);e.state="messageReceived";var d=f.responseText.substring(a.lastIndex);a.lastIndex=f.responseText.length;(g=D(d,a,e))||z(); da(f,a)}else if(400<e.status)return a.lastIndex=f.responseText.length,!1},0);else{var k=h.substring(a.lastIndex,h.length),g=D(k,a,e);a.lastIndex=h.length;if(g)return}else g=D(h,a,e);try{e.status=f.status,e.headers=s(f.getAllResponseHeaders()),P(f,a)}catch(q){e.status=404}e.state=a.suspend?0===e.status?"closed":"messageReceived":"messagePublished";(h="streaming"!==b.transport)&&!a.executeCallbackBeforeReconnect&&A(f,a,0);0===e.responseBody.length||g||z();h&&a.executeCallbackBeforeReconnect&&A(f,a, 0);da(f,a)}}};f.send(a.data);T=!0}else"debug"===a.logLevel&&jQuery.atmosphere.log(a.logLevel,["Max re-connection reached."]),x(0,"maxRequest reached")}}function X(b,a,d){var f=a.url;null!=a.dispatchUrl&&"POST"===a.method&&(f+=a.dispatchUrl);f=I(a,f);f=jQuery.atmosphere.prepareURL(f);d&&(b.open(a.method,f,!0),-1<a.connectTimeout&&(a.id=setTimeout(function(){0===a.requestCount&&(n(),F("Connect timeout","closed",200,a.transport))},a.connectTimeout)));c.withCredentials&&"withCredentials"in b&&(b.withCredentials= !0);c.dropAtmosphereHeaders||(b.setRequestHeader("X-Atmosphere-Framework",jQuery.atmosphere.version),b.setRequestHeader("X-Atmosphere-Transport",a.transport),null!=a.lastTimestamp?b.setRequestHeader("X-Cache-Date",a.lastTimestamp):b.setRequestHeader("X-Cache-Date",0),a.trackMessageLength&&b.setRequestHeader("X-Atmosphere-TrackMessageSize","true"),b.setRequestHeader("X-Atmosphere-tracking-id",a.uuid));""!==a.contentType&&b.setRequestHeader("Content-Type",a.contentType);jQuery.each(a.headers,function(c, f){var g=jQuery.isFunction(f)?f.call(this,b,a,d,e):f;null!=g&&b.setRequestHeader(c,g)})}function A(b,a,c){if(a.reconnect||a.suspend&&T){var f=0;0!==b.readyState&&(f=1E3<b.status?0:b.status);e.status=0===f?204:f;e.reason=0===f?"Server resumed the connection or down.":"OK";clearTimeout(a.id);a.id=setTimeout(function(){U(a)},c)}}function ja(b){b.state="re-connecting";ea(b)}function R(b){"polling"!==b.transport?(t=fa(b),t.open()):fa(b).open()}function fa(b){var a=c;null!=b&&"undefined"!==typeof b&&(a= b);var d=a.transport,f=0,g=new window.XDomainRequest,h=function(){"long-polling"===a.transport&&(a.reconnect&&(-1===a.maxRequest||a.requestCount++<a.maxRequest))&&(g.status=200,R(a))},k=a.rewriteURL||function(a){var b=/(?:^|;\s*)(JSESSIONID|PHPSESSID)=([^;]*)/.exec(document.cookie);switch(b&&b[1]){case "JSESSIONID":return a.replace(/;jsessionid=[^\?]*|(\?)|$/,";jsessionid="+b[2]+"$1");case "PHPSESSID":return a.replace(/\?PHPSESSID=[^&]*&?|\?|$/,"?PHPSESSID="+b[2]+"&").replace(/&$/,"")}return a};g.onprogress= function(){clearTimeout(a.id);var b=g.responseText,b=b.substring(f);f+=b.length;if("polling"!==d){G(a);var c=D(b,a,e);if("long-polling"!==d||0!==jQuery.trim(b))a.executeCallbackBeforeReconnect&&h(),c||F(e.responseBody,"messageReceived",200,d),a.executeCallbackBeforeReconnect||h()}};g.onerror=function(){"polling"!==a.transport&&(n(),B++<a.maxReconnectOnClose?a.id=setTimeout(function(){q("re-connecting",b.transport,b);R(a)},a.reconnectInterval):x(0,"maxReconnectOnClose reached"))};g.onload=function(){}; return{open:function(){var b=a.url;null!=a.dispatchUrl&&(b+=a.dispatchUrl);b=I(a,b);g.open(a.method,k(b));"GET"===a.method?g.send():g.send(a.data);-1<a.connectTimeout&&(a.id=setTimeout(function(){0===a.requestCount&&(n(),F("Connect timeout","closed",200,a.transport))},a.connectTimeout))},close:function(){g.abort()}}}function Z(b){var a=c;null!=b&&"undefined"!==typeof b&&(a=b);var d,f=new window.ActiveXObject("htmlfile");f.open();f.close();var g=a.url;null!=a.dispatchUrl&&(g+=a.dispatchUrl);"polling"!== a.transport&&(e.transport=a.transport);return{open:function(){var b=f.createElement("iframe");g=I(a);""!==a.data&&(g+="&X-Atmosphere-Post-Body="+encodeURIComponent(a.data));g=jQuery.atmosphere.prepareURL(g);b.src=g;f.body.appendChild(b);var h=b.contentDocument||b.contentWindow.document;d=jQuery.atmosphere.iterate(function(){try{if(h.firstChild){if("complete"===h.readyState)try{jQuery.noop(h.fileSize)}catch(b){return F("Connection Failure","error",500,a.transport),!1}var g=h.body?h.body.lastChild: h,k=function(){var a=g.cloneNode(!0);a.appendChild(h.createTextNode("."));a=a.innerText;return a=a.substring(0,a.length-1)};if(!jQuery.nodeName(g,"pre")){var l=h.head||h.getElementsByTagName("head")[0]||h.documentElement||h,n=h.createElement("script");n.text="document.write('<plaintext>')";l.insertBefore(n,l.firstChild);l.removeChild(n);g=h.body.lastChild}a.closed&&(a.isReopen=!0);d=jQuery.atmosphere.iterate(function(){var b=k();if(b.length>a.lastIndex){G(c);e.status=200;e.error=null;g.innerText= "";if(D(b,a,e))return"";F(e.responseBody,"messageReceived",200,a.transport)}a.lastIndex=0;if("complete"===h.readyState)return J(!0),q("re-connecting",a.transport,a),a.id=setTimeout(function(){t=Z(a);t.open()},a.reconnectInterval),!1},null);return!1}}catch(m){return e.error=!0,q("re-connecting",a.transport,a),B++<a.maxReconnectOnClose?a.id=setTimeout(function(){t=Z(a);t.open()},a.reconnectInterval):x(0,"maxReconnectOnClose reached"),f.execCommand("Stop"),f.close(),!1}})},close:function(){d&&d();f.execCommand("Stop"); J(!0)}}}function W(b){null!=v?v.send(b):null!=K||null!=y?S(b):null!=t?c.enableXDR&&jQuery.atmosphere.checkCORSSupport()?(b=ga(b),b.reconnect=!1,ba(b)):S(b):null!=u?S(b):null!=l&&ma(b)}function S(b){b=ga(b);U(b)}function ha(b){var a=b;"object"===typeof a&&(a=b.data);return a}function ga(b){var a=ha(b),a={connected:!1,timeout:6E4,method:"POST",url:c.url,contentType:c.contentType,headers:c.headers,reconnect:!0,callback:null,data:a,suspend:!1,maxRequest:-1,logLevel:"info",requestCount:0,withCredentials:c.withCredentials, transport:"polling",isOpen:!0,attachHeadersAsQueryString:!0,enableXDR:c.enableXDR,uuid:c.uuid,dispatchUrl:c.dispatchUrl,enableProtocol:!1,messageDelimiter:"|",maxReconnectOnClose:c.maxReconnectOnClose};"object"===typeof b&&(a=jQuery.extend(a,b));return a}function ma(b){var a=ha(b),e;try{e=null!=c.dispatchUrl?c.webSocketPathDelimiter+c.dispatchUrl+c.webSocketPathDelimiter+a:a,l.send(e)}catch(f){l.onclose=function(a){},n(),L("Websocket failed. Downgrading to Comet and resending "+e),S(b)}}function $(b){b= jQuery.parseJSON(b);if(b.id!==E)if("undefined"!==typeof c.onLocalMessage)c.onLocalMessage(b.event);else if("undefined"!==typeof jQuery.atmosphere.onLocalMessage)jQuery.atmosphere.onLocalMessage(b.event)}function F(b,a,c,f){e.responseBody=b;e.transport=f;e.status=c;e.state=a;z()}function P(b,a){if(a.readResponsesHeaders||a.enableProtocol)try{var d=b.getResponseHeader("X-Cache-Date");d&&(null!=d&&0<d.length)&&(a.lastTimestamp=d.split(" ").pop());var f=b.getResponseHeader("X-Atmosphere-tracking-id"); f&&null!=f&&(a.uuid=f.split(" ").pop());a.headers&&jQuery.each(c.headers,function(a){var c=b.getResponseHeader(a);c&&(e.headers[a]=c)})}catch(g){}else a.lastTimestamp=jQuery.now(),a.uuid=jQuery.atmosphere.guid()}function ea(b){ia(b,c);ia(b,jQuery.atmosphere)}function ia(b,a){switch(b.state){case "messageReceived":B=0;if("undefined"!==typeof a.onMessage)a.onMessage(b);break;case "error":if("undefined"!==typeof a.onError)a.onError(b);break;case "opening":if("undefined"!==typeof a.onOpen)a.onOpen(b); break;case "messagePublished":if("undefined"!==typeof a.onMessagePublished)a.onMessagePublished(b);break;case "re-connecting":if("undefined"!==typeof a.onReconnect)a.onReconnect(c,b);break;case "re-opening":if("undefined"!==typeof a.onReopen)a.onReopen(c,b);break;case "fail-to-reconnect":if("undefined"!==typeof a.onFailureToReconnect)a.onFailureToReconnect(c,b);break;case "unsubscribe":case "closed":var e="undefined"!==typeof c.closed?c.closed:!1;if("undefined"!==typeof a.onClose&&!e)a.onClose(b); c.closed=!0}}function J(b){"closed"!==e.state&&(e.state="closed",e.responseBody="",e.messages=[],e.status=b?200:501,z())}function z(){var b=function(a,b){b(e)};null==v&&null!=M&&M(e.responseBody);c.reconnect=c.mrequest;for(var a="string"===typeof e.responseBody,d=a&&c.trackMessageLength?0<e.messages.length?e.messages:[""]:Array(e.responseBody),f=0;f<d.length;f++)if(!(1<d.length&&0===d[f].length)&&(e.responseBody=a?jQuery.trim(d[f]):d[f],null==v&&null!=M&&M(e.responseBody),0!==e.responseBody.length|| "messageReceived"!==e.state)){ea(e);if(0<jQuery.atmosphere.callbacks.length){"debug"===c.logLevel&&jQuery.atmosphere.debug("Invoking "+jQuery.atmosphere.callbacks.length+" global callbacks: "+e.state);try{jQuery.each(jQuery.atmosphere.callbacks,b)}catch(g){jQuery.atmosphere.log(c.logLevel,["Callback exception"+g])}}if("function"===typeof c.callback){"debug"===c.logLevel&&jQuery.atmosphere.debug("Invoking request callbacks");try{c.callback(e)}catch(h){jQuery.atmosphere.log(c.logLevel,["Callback exception"+ h])}}}}function da(b,a){""===e.partialMessage&&("streaming"===a.transport&&b.responseText.length>a.maxStreamingLength)&&(e.messages=[],J(!0),Q(),n(),A(b,a,0))}function Q(){if(c.enableProtocol&&!c.firstMessage){var b="X-Atmosphere-Transport=close&X-Atmosphere-tracking-id="+c.uuid,a=c.url.replace(/([?&])_=[^&]*/,b),a=a+(a===c.url?(/\?/.test(c.url)?"&":"?")+b:"");-1<c.connectTimeout?jQuery.ajax({url:a,async:!1,timeout:c.connectTimeout}):jQuery.ajax({url:a,async:!1})}}function N(){c.reconnect=!1;H=!0; e.request=c;e.state="unsubscribe";e.responseBody="";e.status=408;z();Q();n()}function n(){c.id&&clearTimeout(c.id);null!=t&&(t.close(),t=null);null!=u&&(u.abort(),u=null);null!=K&&(K.abort(),K=null);null!=l&&(l.webSocketOpened&&l.close(),l=null);null!=y&&(y.close(),y=null);null!=C&&(clearInterval(O),document.cookie=encodeURIComponent("atmosphere-"+c.url)+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT",C.signal("close",{reason:"",heir:H?(C.get("children")||[])[0]:E}),C.close());null!=v&&v.close()}var c= {timeout:3E5,method:"GET",headers:{},contentType:"",callback:null,url:"",data:"",suspend:!0,maxRequest:-1,reconnect:!0,maxStreamingLength:1E7,lastIndex:0,logLevel:"info",requestCount:0,fallbackMethod:"GET",fallbackTransport:"streaming",transport:"long-polling",webSocketImpl:null,webSocketBinaryType:null,dispatchUrl:null,webSocketPathDelimiter:"@@",enableXDR:!1,rewriteURL:!1,attachHeadersAsQueryString:!0,executeCallbackBeforeReconnect:!1,readyState:0,lastTimestamp:0,withCredentials:!1,trackMessageLength:!1, messageDelimiter:"|",connectTimeout:-1,reconnectInterval:0,dropAtmosphereHeaders:!0,uuid:0,shared:!1,readResponsesHeaders:!1,maxReconnectOnClose:5,enableProtocol:!0,onError:function(b){},onClose:function(b){},onOpen:function(b){},onMessage:function(b){},onReopen:function(b,a){},onReconnect:function(b,a){},onMessagePublished:function(b){},onTransportFailure:function(b,a){},onLocalMessage:function(b){},onFailureToReconnect:function(b,a){}},e={status:200,reasonPhrase:"OK",responseBody:"",messages:[], headers:[],state:"messageReceived",transport:"polling",error:null,request:null,partialMessage:"",errorHandled:!1,id:0},l=null,y=null,K=null,t=null,u=null,T=!0,B=0,H=!1,M=null,C,v=null,E=jQuery.now(),O;g(d);this.subscribe=function(b){g(b);h()};this.execute=function(){h()};this.invokeCallback=function(){z()};this.close=function(){N()};this.disconnect=function(){Q()};this.getUrl=function(){return c.url};this.push=function(b,a){if(null!=a){var e=c.dispatchUrl;c.dispatchUrl=a;W(b);c.dispatchUrl=e}else W(b)}; this.getUUID=function(){return c.uuid};this.pushLocal=function(b){if(0!==b.length)try{v?v.localSend(b):C&&C.signal("localMessage",jQuery.stringifyJSON({id:E,event:b}))}catch(a){jQuery.atmosphere.error(a)}};this.enableProtocol=function(b){return c.enableProtocol};this.request=c;this.response=e},subscribe:function(d,g,h){"function"===typeof g&&jQuery.atmosphere.addCallback(g);"string"!==typeof d?h=d:h.url=d;d=new jQuery.atmosphere.AtmosphereRequest(h);d.execute();return jQuery.atmosphere.requests[jQuery.atmosphere.requests.length]= d},addCallback:function(d){-1===jQuery.inArray(d,jQuery.atmosphere.callbacks)&&jQuery.atmosphere.callbacks.push(d)},removeCallback:function(d){d=jQuery.inArray(d,jQuery.atmosphere.callbacks);-1!==d&&jQuery.atmosphere.callbacks.splice(d,1)},unsubscribe:function(){if(0<jQuery.atmosphere.requests.length)for(var d=[].concat(jQuery.atmosphere.requests),g=0;g<d.length;g++){var h=d[g];h.close();clearTimeout(h.response.request.id)}jQuery.atmosphere.requests=[];jQuery.atmosphere.callbacks=[]},unsubscribeUrl:function(d){var g= -1;if(0<jQuery.atmosphere.requests.length)for(var h=0;h<jQuery.atmosphere.requests.length;h++){var m=jQuery.atmosphere.requests[h];if(m.getUrl()===d){m.close();clearTimeout(m.response.request.id);g=h;break}}0<=g&&jQuery.atmosphere.requests.splice(g,1)},publish:function(d){"function"===typeof d.callback&&jQuery.atmosphere.addCallback(d.callback);d.transport="polling";d=new jQuery.atmosphere.AtmosphereRequest(d);return jQuery.atmosphere.requests[jQuery.atmosphere.requests.length]=d},checkCORSSupport:function(){return jQuery.browser.msie&& !window.XDomainRequest||jQuery.browser.opera&&12>jQuery.browser.version?!0:-1<navigator.userAgent.toLowerCase().indexOf("android")?!0:!1},S4:function(){return(65536*(1+Math.random())|0).toString(16).substring(1)},guid:function(){return jQuery.atmosphere.S4()+jQuery.atmosphere.S4()+"-"+jQuery.atmosphere.S4()+"-"+jQuery.atmosphere.S4()+"-"+jQuery.atmosphere.S4()+"-"+jQuery.atmosphere.S4()+jQuery.atmosphere.S4()+jQuery.atmosphere.S4()},prepareURL:function(d){var g=jQuery.now(),h=d.replace(/([?&])_=[^&]*/, "$1_="+g);return h+(h===d?(/\?/.test(d)?"&":"?")+"_="+g:"")},param:function(d){return jQuery.param(d,jQuery.ajaxSettings.traditional)},supportStorage:function(){var d=window.localStorage;if(d)try{return d.setItem("t","t"),d.removeItem("t"),window.StorageEvent&&!jQuery.browser.msie&&!(jQuery.browser.mozilla&&"1"===jQuery.browser.version.split(".")[0])}catch(g){}return!1},iterate:function(d,g){var h;g=g||0;(function r(){h=setTimeout(function(){!1!==d()&&r()},g)})();return function(){clearTimeout(h)}}, log:function(d,g){if(window.console){var h=window.console[d];"function"===typeof h&&h.apply(window.console,g)}},warn:function(){jQuery.atmosphere.log("warn",arguments)},info:function(){jQuery.atmosphere.log("info",arguments)},debug:function(){jQuery.atmosphere.log("debug",arguments)},error:function(){jQuery.atmosphere.log("error",arguments)}}}(); (function(){var s,d;jQuery.uaMatch=function(d){d=d.toLowerCase();d=/(chrome)[ \/]([\w.]+)/.exec(d)||/(webkit)[ \/]([\w.]+)/.exec(d)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(d)||/(msie) ([\w.]+)/.exec(d)||0>d.indexOf("compatible")&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(d)||[];return{browser:d[1]||"",version:d[2]||"0"}};s=jQuery.uaMatch(navigator.userAgent);d={};s.browser&&(d[s.browser]=!0,d.version=s.version);d.chrome?d.webkit=!0:d.webkit&&(d.safari=!0);jQuery.browser=d;jQuery.sub=function(){function d(h, r){return new d.fn.init(h,r)}jQuery.extend(!0,d,this);d.superclass=this;d.fn=d.prototype=this();d.fn.constructor=d;d.sub=this.sub;d.fn.init=function(m,r){r&&(r instanceof jQuery&&!(r instanceof d))&&(r=d(r));return jQuery.fn.init.call(this,m,r,h)};d.fn.init.prototype=d.fn;var h=d(document);return d}})(); (function(s){function d(d){return'"'+d.replace(m,function(d){var g=r[d];return"string"===typeof g?g:"\\u"+("0000"+d.charCodeAt(0).toString(16)).slice(-4)})+'"'}function g(d){return 10>d?"0"+d:d}function h(q,r){var m,s,w,k=r[q];w=typeof k;k&&("object"===typeof k&&"function"===typeof k.toJSON)&&(k=k.toJSON(q),w=typeof k);switch(w){case "string":return d(k);case "number":return isFinite(k)?String(k):"null";case "boolean":return String(k);case "object":if(!k)return"null";switch(Object.prototype.toString.call(k)){case "[object Date]":return isFinite(k.valueOf())? '"'+k.getUTCFullYear()+"-"+g(k.getUTCMonth()+1)+"-"+g(k.getUTCDate())+"T"+g(k.getUTCHours())+":"+g(k.getUTCMinutes())+":"+g(k.getUTCSeconds())+'Z"':"null";case "[object Array]":s=k.length;w=[];for(m=0;m<s;m++)w.push(h(m,k)||"null");return"["+w.join(",")+"]";default:w=[];for(m in k)Object.prototype.hasOwnProperty.call(k,m)&&(s=h(m,k))&&w.push(d(m)+":"+s);return"{"+w.join(",")+"}"}}}var m=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g, r={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};s.stringifyJSON=function(d){return window.JSON&&window.JSON.stringify?window.JSON.stringify(d):h("",{"":d})}})(jQuery);