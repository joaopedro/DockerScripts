<?xml version="1.0" encoding="UTF-8"?>

<flow xmlns="http://www.springframework.org/schema/webflow"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="http://www.springframework.org/schema/webflow
  						http://www.springframework.org/schema/webflow/spring-webflow-1.0.xsd">		

	<start-actions>
		<action bean="dynamicFormAction" method="setupForm" />
		<action bean="dynamicFormAction" method="preFillSessionValues" />
		<action bean="flowUtils" method="establishReferer" />		
	</start-actions>
  						
  	<start-state idref="formScreen" />

	<!-- DYNAMIC SCREEN FORM -->
	<view-state id="formScreen" view="webflow.dynamic.formscreen">
		<!--entry-actions>
			<action bean="dynamicFormAction" method="initializeFlowBeanWithDynamicTemplate">
				<attribute name="form" value="141" />
			</action>
		</entry-actions-->
   		<transition on="next" to="processDynamicForm" />
   		<transition on="refreshDynamicValues" to="formScreenAjax">
   			<action bean="dynamicFormAction" method="refreshDynamicValues" />
   		</transition>
   		<transition on="suspend" to="suspender" >
   			<set attribute="isAjax" value="false" scope="flow"></set>
   		</transition>
	</view-state>
	<view-state id="formScreenAjax" view="webflow.dynamic.formscreen.ajax">
		<!--entry-actions>
			<action bean="dynamicFormAction" method="initializeFlowBeanWithDynamicTemplate">
				<attribute name="form" value="141" />
			</action>
		</entry-actions-->
   		<transition on="next" to="processDynamicForm" />
   		<transition on="refreshDynamicValues" to="formScreenAjax">
   			<action bean="dynamicFormAction" method="refreshDynamicValues" />
   		</transition>
   		   		<transition on="suspend" to="suspender" >
   			<set attribute="isAjax" value="true" scope="flow"></set>
   		</transition>
	</view-state>
	<action-state id="processDynamicForm">
		<entry-actions>
			<action bean="dynamicFormAction" method="bindDynamicValues" />
		</entry-actions>
		<action bean="dynamicFormAction" method="bindAndValidate">
			<attribute name="validatorMethod" value="validateDynamicForm" />
		</action>
		<transition on="success" to="integracaoEsri" />
		<transition on="error" to="formScreenAjax" />
	</action-state>

	<!-- INTEGRACAO ESRI SCREEN -->
	<view-state id="integracaoEsri" view="webflow.dynamic.sig.esri">
		<entry-actions>
			<action bean="dynamicFormAction" method="generateSigId"/>
		</entry-actions>
		<transition on="back" to="formScreenAjax">
			<action bean="dynamicFormAction" method="bind" />
		</transition>
		<transition on="next" to="resumo" />
	</view-state>
		
	<!-- PRESUBMIT SCREEN -->
	<view-state id="resumo" view="webflow.dynamic.resumoscreen">
		<transition on="back" to="integracaoEsri">
			<action bean="dynamicFormAction" method="bind" />
		</transition>
		<transition on="next" to="save" />
		<transition on="suspend" to="suspender">
			<set attribute="isAjax" value="true" scope="flow"></set>
		</transition>
	</view-state>
	
	<action-state id="suspender">
			<action bean="dynamicFormAction" method="bindDynamicValues"  />
			<transition on="success" to="afterBindingDynamicValues" >				
			</transition>			
	</action-state>
	
	<action-state id="afterBindingDynamicValues">
		<action bean="dynamicFormAction" method="suspend"></action>
		
		<transition to="quercontinuar" on = "${false == flowScope.isAjax}" />
		
		<transition to="quercontinuarAjax" on = "${true ==flowScope.isAjax}"></transition>
	</action-state>
	
	<view-state id="quercontinuarAjax" view="ipdms.webflow.quercontinuar.ajax">
		<transition on="sim" to="${flowScope.viewstatehistory.beforeLast}">
			<action bean="dynamicFormAction" method="bind" />
		</transition>
		<transition on="nao" to="cancelar"/>
	</view-state>
	
	<view-state id="quercontinuar" view="ipdms.webflow.quercontinuar">
		<transition on="sim" to="${flowScope.viewstatehistory.beforeLast}">
			<action bean="dynamicFormAction" method="bind" />
		</transition>
		<transition on="nao" to="cancelar"/>
	</view-state>
	
	
	<!-- SAVE -->
	<action-state id="save">
		<action bean="dynamicFormAction" method="save"/>
		<transition on="success" to="relatorio"/>
		<transition on="error" to="save.error"/>
	</action-state>

	<!-- END SCREEN -->
	<view-state id="relatorio" view="webflow.dynamic.endscreen">
		<transition on="next" to="concluir" />
	</view-state>
	
	<!-- GLOBAL END STATES -->
	<end-state id="concluir" view="externalRedirect:${flowScope.relativeReferer}" />
	<end-state id="cancelar" view="externalRedirect:${flowScope.relativeReferer}" />
	<end-state id="save.error" view="ipdms.error.default.ajax" />
	
	<global-transitions>
		<transition on="cancel" to="cancelar" />
	</global-transitions>
</flow>
