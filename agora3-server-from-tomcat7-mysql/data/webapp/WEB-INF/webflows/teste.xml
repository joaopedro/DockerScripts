<?xml version="1.0" encoding="UTF-8"?>

<flow xmlns="http://www.springframework.org/schema/webflow"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="http://www.springframework.org/schema/webflow
  						http://www.springframework.org/schema/webflow/spring-webflow-1.0.xsd">		

	<start-actions>
		<action bean="testeFormAction" method="setupForm" />
		<action bean="flowUtils" method="establishReferer" />		
	</start-actions>
  						
  	<start-state idref="iniciarPedido" />

	<!-- 1IDENTIFICAÇÃO DO EMITENTE -->
	<view-state id="iniciarPedido" view="webflow.teste.inicio">
		<attribute name="ajaxEquivalent" value="iniciarPedidoAjax" />
   		<transition on="next" to="processarPedido" />
   		<transition on="suspend" to="suspender" />
	</view-state>
	<view-state id="iniciarPedidoAjax" view="webflow.teste.inicio.ajax">
   		<transition on="next" to="processarPedido" />
   		<transition on="suspend" to="suspender" />
	</view-state>
	<action-state id="processarPedido">
		<action bean="testeFormAction" method="bindAndValidate">
			<attribute name="validatorMethod" value="validarRequerente" />
		</action>
		<transition on="success" to="ecra2" />
		<transition on="error" to="iniciarPedidoAjax" />
	</action-state>

	<!-- 2 ECRA 2-->
	<view-state id="ecra2" view="webflow.teste.ecra2">
   		<transition on="refresh" to="ecra2">
			<action bean="testeFormAction" method="bindAndValidate">
				<attribute name="validatorMethod" value="validarLinhaEcra2" />			
			</action>
			<action bean="testeFormAction" method="addEcra2"/>
   		</transition>
   		<transition on="delete" to="ecra2">
			<action bean="testeFormAction" method="bindAndValidate"/>
			<action bean="testeFormAction" method="removeEcra2"/>
   		</transition>
   		<transition on="subFlow" to="subflowdecision">
			<action bean="testeFormAction" method="bindAndValidate"/>
   			<set attribute="tipo" value="flowScope.teste.subFlow.numeroConteudo" scope="flow" />
   		</transition>
   		<transition on="next" to="processarEcra2" />
   		<transition on="back" to="iniciarPedidoAjax">
			<action bean="testeFormAction" method="bindAndValidate"/>
   		</transition>
	</view-state>
	<action-state id="processarEcra2">
		<action bean="testeFormAction" method="bindAndValidate">
			<attribute name="validatorMethod" value="validarEcra2" />
		</action>
		<action bean="testeFormAction" method="xpto" />
		<transition on="success" to="createDocAnexadoQrCodeStickerAjax" />
		<transition on="error" to="ecra2" />
	</action-state>

	<decision-state id="subflowdecision">
		<if test="${flowScope.teste.subFlow.idExterno == 'sub'}" then="subflowteste"/>
		<if test="${flowScope.teste.subFlow.idExterno == 'sub2'}" then="subflowteste2"/>
	</decision-state>

	<subflow-state id="subflowteste"  flow="subflow-teste">
		<attribute-mapper>
			<input-mapper>
				<input-attribute name="tipo" required="true"/>
			</input-mapper>
			<output-mapper>
				<output-attribute name="resultMessage"/>
			</output-mapper>
		</attribute-mapper>
		<transition to="ecra2" />
		<exit-actions>
			<action bean="testeFormAction" method="bind" />		
		</exit-actions>
	</subflow-state>

	<subflow-state id="subflowteste2"  flow="subflow-teste">
		<attribute-mapper>
			<input-mapper>
				<input-attribute name="tipo" required="true"/>
			</input-mapper>
			<output-mapper>
				<output-attribute name="resultMessage"/>
			</output-mapper>
		</attribute-mapper>
		<transition to="ecra2" />
		<exit-actions>
			<action bean="testeFormAction" method="bind" />		
		</exit-actions>
	</subflow-state>

	<view-state id="createDocAnexadoQrCodeSticker" view="webflow.teste.docanexasdoqrcodesticker">
		<transition to="preencherDocumentos" on="next">
			<action bean="testeFormAction" method="bind" />
		</transition>
		<transition to="createDocAnexadoQrCodeStickerAjax" on="createqrcode">
			<action bean="testeFormAction" method="addNewBarCodeStickerDocAnexado" />
		</transition>
		<transition to="ecra2" on="back">
			<action bean="testeFormAction" method="bind"/>
		</transition>
	</view-state>
	<view-state id="createDocAnexadoQrCodeStickerAjax" view="webflow.teste.docanexasdoqrcodesticker.ajax">
		<transition to="preencherDocumentos" on="next">
			<action bean="testeFormAction" method="bind" />
		</transition>
		<transition to="createDocAnexadoQrCodeStickerAjax" on="createqrcode">
			<action bean="testeFormAction" method="addNewBarCodeStickerDocAnexado" />
		</transition>
		<transition to="ecra2" on="back">
			<action bean="testeFormAction" method="bind"/>
		</transition>
	</view-state>



	<!-- Ecra de Anexar Documento -->
	<view-state id="preencherDocumentos" view="webflow.teste.anexardocumentos">
		<transition on="back" to="createDocAnexadoQrCodeSticker">
			<action bean="testeFormAction" method="bind" />
		</transition>
   		<transition on="next" to="processarDocumentos" />
   		<transition on="add" to="preencherAdicionarDocumentos" />
   		<transition on="delete" to="preencherDocumentos">
   			<action bean="testeFormAction" method="deleteDocumentosAnexados" />
   		</transition>
   		<transition on="recover" to="preencherDocumentos">
   			<action bean="testeFormAction" method="recoverDocumentosAnexados" />
   		</transition>
	</view-state>
	<action-state id="processarDocumentos">
		<action bean="testeFormAction" method="uploadFiles">
			<attribute name="validatorMethod" value="validateDocAnexadosUpload" />
		</action>
		<transition on="success" to="createDocItemQrCodeSticker" />
		<transition on="error" to="preencherDocumentos" />
		<transition on="dirs-nok" to="servicoindisponivel" />
	</action-state>
	<action-state id="preencherAdicionarDocumentos">
		<action bean="testeFormAction" method="uploadFiles" />
		<transition on="success" to="preencherDocumentos" />
		<transition on="error" to="preencherDocumentos" />
		<transition on="dirs-nok" to="servicoindisponivel" />
	</action-state>

	<view-state id="createDocItemQrCodeSticker" view="webflow.teste.docitemqrcodesticker">
		<transition to="processCheckDocsInstrucao" on="next" />			
		<transition to="createDocItemQrCodeSticker" on="createqrcode">
			<action bean="testeFormAction" method="addNewBarCodeStickerDocItem" />
		</transition>
		<transition to="preencherDocumentos" on="back">
			<action bean="testeFormAction" method="bind"/>
		</transition>
	</view-state>	
	<action-state id="processCheckDocsInstrucao">
		<entry-actions>
			<action bean="testeFormAction" method="bind" />
		</entry-actions>		
		<action bean="testeFormAction" method="checkDocsInstrucao" />
		<transition on="success" to="adicionarDocumentos" />
		<transition on="error" to="createDocItemQrCodeSticker" />		
		<transition on="jump_to" to="escolherDocumentoPrincipal" />	
	</action-state>


	<!-- Ecra adicionar documentos por item de conjunto -->
	<view-state id="adicionarDocumentos" view="webflow.teste.adddocumentobyitem">
		<transition on="back" to="createDocItemQrCodeSticker">
			<action bean="testeFormAction" method="resetDocumentoFisico" />
			<action bean="testeFormAction" method="bind" />
		</transition>
		<transition on="next" to="uploadAdicionarDocumentos">
			<action bean="testeFormAction" method="resetDocumentoFisico" />
		</transition>
	</view-state>
	<action-state id="uploadAdicionarDocumentos">
		<action bean="testeFormAction" method="uploadFilesOfItens">
			<attribute name="validatorMethod" value="validateDocItensUpload" />
		</action>
		<transition to="adicionarDocumentos" on="error" />
		<transition to="escolherDocumentoPrincipal" on="success"></transition>
	</action-state>

	<!-- Ecra para seleccionar o documento principal -->
	<view-state id="escolherDocumentoPrincipal" view="webflow.teste.chooseanexomainfile">
		<transition on="back" to="processback" />			
		<transition on="next" to="escolheDocumentoPrincipal" />
	</view-state>
	<view-state id="escolherDocumentoPrincipalAjax" view="webflow.teste.chooseanexomainfile.ajax">
		<transition on="back" to="processback" />			
		<transition on="next" to="escolheDocumentoPrincipal" />
	</view-state>
	<action-state id="escolheDocumentoPrincipal">
		<entry-actions>
			<action bean="testeFormAction" method="resetMainFile" />
		</entry-actions>
		<action bean="testeFormAction" method="bindAndValidate">
			<attribute name="validatorMethod" value="validateMainFile" />			
		</action>
		<transition to="escolherDocumentoPrincipalAjax" on="error" />
		<transition to="addQrCodeToFiles" on="success" />
	</action-state>
	<action-state id="processback">		
		<entry-actions>
			<action bean="testeFormAction" method="bind" />
		</entry-actions>
		<action bean="testeFormAction" method="checkDocsInstrucao" />					
		<transition on="success" to="adicionarDocumentos" />		
		<transition on="jump_to" to="createDocItemQrCodeSticker" />
	</action-state>

	<!-- Ecra para adicionar QR Codes -->
	<view-state id="addQrCodeToFiles" view="webflow.teste.addqrcode.ajax">
		<entry-actions>
			<action bean="testeFormAction" method="initializeBarCodeAndPDFProps" />
		</entry-actions>
		<transition to="convertToPdf" on="convertToPdf">
			<action bean="testeFormAction" method="bind" />
		</transition>
		<transition to="popup" on="next">
			<action bean="testeFormAction" method="addBarCodeToFiles" />
		</transition>
		<transition to="escolherDocumentoPrincipalAjax" on="back">
			<action bean="testeFormAction" method="bind"/>
		</transition>
	</view-state>

	<!-- Ecra para converter documentos para PDF -->
	<view-state id="convertToPdf" view="webflow.teste.converttopdf">
		<transition to="addQrCodeToFiles" on="back">
			<action bean="testeFormAction" method="bind"/>
		</transition>
		<transition to="convertToPdf" on="convert">
			<action bean="testeFormAction" method="bind"/>
			<action bean="testeFormAction" method="convertDocumentsToPdf" />
		</transition>
	</view-state>

	<!-- Ecra popup teste -->
	<view-state id="popup" view="webflow.teste.popup">
   		<transition on="next" to="processarPopup" />
   		<transition on="back" to="addQrCodeToFiles">   		
			<action bean="testeFormAction" method="bind"/>
   		</transition>
   		<transition on="suspend" to="suspender">
			<action bean="testeFormAction" method="bind"/>
   		</transition>
	</view-state>
	<action-state id="processarPopup">
		<action bean="testeFormAction" method="bindAndValidate"/>
		<transition on="success" to="resumo" />
		<transition on="error" to="popup" />
	</action-state>
	
	
	<view-state id="resumo" view="webflow.teste.resumo">
		<transition on="back" to="popup">
			<action bean="testeFormAction" method="bind" />
		</transition>
		<transition on="next" to="save" />
	</view-state>
	
	
	<!-- GRAVAÇÃO -->
	<action-state id="save">
		<action bean="testeFormAction" method="save"/>
		<transition on="success" to="relatorio"/>
		<transition on="error" to="resumo"/>
	</action-state>

	<!-- RELATÓRIO -->
	<view-state id="relatorio" view="webflow.teste.relatorio">
		<transition on="next" to="concluir" />
	</view-state>

	<action-state id="suspender">
		<action bean="testeFormAction" method="suspend" />
		<transition on="success" to="quercontinuar" />
	</action-state>

	<view-state id="quercontinuar" view="ipdms.webflow.quercontinuar">
		<transition on="sim" to="${flowScope.viewstatehistory.beforeLast}">
			<action bean="testeFormAction" method="bind" />
		</transition>
		<transition on="nao" to="cancelar"/>
	</view-state>

	<view-state id="quercontinuarAjax" view="ipdms.webflow.quercontinuar.ajax">
		<transition on="sim" to="${flowScope.viewstatehistory.beforeLast}">
			<action bean="testeFormAction" method="bind" />
		</transition>
		<transition on="nao" to="cancelar"/>
	</view-state>
	
	<!-- ECRÃS FINAIS -->
	<end-state id="concluir" view="externalRedirect:${flowScope.relativeReferer}" />
	<end-state id="cancelar" view="externalRedirect:${flowScope.relativeReferer}" />
	
	<global-transitions>
		<transition on="cancel" to="cancelar" />
	</global-transitions>
</flow>
