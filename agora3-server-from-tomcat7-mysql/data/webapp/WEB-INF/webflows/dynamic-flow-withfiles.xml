<?xml version="1.0" encoding="UTF-8"?>

<webflow:flow xmlns:webflow="http://www.springframework.org/schema/webflow"
              xmlns:ns0="http://www.w3.org/2001/XMLSchema-instance"
              ns0:schemaLocation="http://www.springframework.org/schema/webflow
              http://www.springframework.org/schema/webflow/spring-webflow-2.0.xsd"
              start-state="formScreen">

    <webflow:input name="tipo"/>
    <webflow:input name="entidadeId"/>
    <webflow:input name="assunto"/>
    <webflow:input name="form"/>
    <webflow:on-start>
        <webflow:evaluate expression="dynamicFormAction.setupForm"/>
        <webflow:evaluate expression="dynamicFormAction.preFillSessionValues"/>
        <webflow:evaluate expression="flowUtils.establishReferer"/>
    </webflow:on-start>

    <!-- DYNAMIC SCREEN FORM -->
    <!--<webflow:view-state id="formScreen" view="webflow.dynamic.formscreen">-->
    <webflow:view-state id="formScreen" view="agora.webflow.dynamic.formscreen">
        <webflow:transition on="next" to="processDynamicForm"/>
    <webflow:transition on="refreshDynamicValues" to="formScreenAjax">
        <webflow:evaluate expression="dynamicFormAction.refreshDynamicValues"/>
    </webflow:transition>
    <webflow:transition on="suspend" to="suspender">
        <webflow:set name="flowScope.isAjax" value="false"/>
    </webflow:transition>
    </webflow:view-state>
    <!--<webflow:view-state id="formScreenAjax" view="webflow.dynamic.formscreen.ajax">-->
    <webflow:view-state id="formScreenAjax" view="agora.webflow.dynamic.formscreen.ajax">
        <webflow:transition on="next" to="processDynamicForm"/>
        <webflow:transition on="refreshDynamicValues" to="formScreenAjax">
            <webflow:evaluate expression="dynamicFormAction.refreshDynamicValues"/>
        </webflow:transition>
        <webflow:transition on="suspend" to="suspender">
            <webflow:set name="flowScope.isAjax" value="true"/>
        </webflow:transition>
    </webflow:view-state>
    <webflow:action-state id="processDynamicForm">
        <webflow:on-entry>
            <webflow:evaluate expression="dynamicFormAction.bindDynamicValues"/>
        </webflow:on-entry>
        <webflow:evaluate expression="dynamicFormAction.bindAndValidate">
            <webflow:attribute name="validatorMethod" value="validateDynamicForm"/>
        </webflow:evaluate>
        <webflow:transition on="success" to="verify_adicionarDocumentos_screen"/>
        <webflow:transition on="error" to="formScreenAjax"/>
    </webflow:action-state>
    <webflow:action-state id="verify_adicionarDocumentos_screen">
        <webflow:on-entry>
            <webflow:evaluate expression="dynamicFormAction.bind"/>
        </webflow:on-entry>
        <webflow:evaluate expression="dynamicFormAction.checkDocsInstrucao"/>
        <webflow:transition on="success" to="adicionarDocumentosAjax"/>
        <webflow:transition on="jump_to" to="preencherDocumentosAjax"/>
    </webflow:action-state>

    <!-- Ecra adicionar documentos por item de conjunto -->
    <!--<webflow:view-state id="adicionarDocumentos" view="webflow.dynamic.adddocumentobyitem">-->
    <webflow:view-state id="adicionarDocumentos" view="agora.webflow.dynamic.adddocumentobyitem">
    <webflow:transition on="back" to="formScreen">
        <webflow:evaluate expression="dynamicFormAction.resetDocumentoFisico"/>
        <webflow:evaluate expression="dynamicFormAction.bind"/>
    </webflow:transition>
    <webflow:transition on="next" to="uploadAdicionarDocumentos">
        <webflow:evaluate expression="dynamicFormAction.resetDocumentoFisico"/>
    </webflow:transition>
    </webflow:view-state>
    <!--<webflow:view-state id="adicionarDocumentosAjax" view="webflow.dynamic.adddocumentobyitem.ajax">-->
    <webflow:view-state id="adicionarDocumentosAjax" view="agora.webflow.dynamic.adddocumentobyitem.ajax">
        <webflow:transition on="back" to="formScreen">
            <webflow:evaluate expression="dynamicFormAction.resetDocumentoFisico"/>
            <webflow:evaluate expression="dynamicFormAction.bind"/>
        </webflow:transition>
        <webflow:transition on="next" to="uploadAdicionarDocumentos">
            <webflow:evaluate expression="dynamicFormAction.resetDocumentoFisico"/>
        </webflow:transition>
    </webflow:view-state>
    <webflow:action-state id="uploadAdicionarDocumentos">
        <webflow:evaluate expression="dynamicFormAction.uploadFilesOfItens">
            <webflow:attribute name="validatorMethod" value="validateMandatoryTipificacoesInItemFiles"/>
        </webflow:evaluate>
        <webflow:transition on="error" to="adicionarDocumentos"/>
        <webflow:transition on="success" to="preencherDocumentos"/>
    </webflow:action-state>

    <!-- Ecra de Anexar Documento -->
    <!--<webflow:view-state id="preencherDocumentosAjax" view="webflow.dynamic.anexardocumentos.ajax">-->
    <webflow:view-state id="preencherDocumentosAjax" view="agora.webflow.dynamic.anexardocumentos.ajax">
    <webflow:transition on="back" to="processback"/>
    <webflow:transition on="next" to="processarDocumentos"/>
    <webflow:transition on="add" to="preencherAdicionarDocumentos"/>
    <webflow:transition on="delete" to="preencherDocumentos">
        <webflow:evaluate expression="dynamicFormAction.deleteDocumentosAnexados"/>
    </webflow:transition>
    <webflow:transition on="recover" to="preencherDocumentos">
        <webflow:evaluate expression="dynamicFormAction.recoverDocumentosAnexados"/>
    </webflow:transition>
    </webflow:view-state>
    <!--<webflow:view-state id="preencherDocumentos" view="webflow.dynamic.anexardocumentos">-->
    <webflow:view-state id="preencherDocumentos" view="agora.webflow.dynamic.anexardocumentos">
        <webflow:transition on="back" to="processback"/>
        <webflow:transition on="next" to="processarDocumentos"/>
        <webflow:transition on="add" to="preencherAdicionarDocumentos"/>
        <webflow:transition on="delete" to="preencherDocumentos">
            <webflow:evaluate expression="dynamicFormAction.deleteDocumentosAnexados"/>
        </webflow:transition>
        <webflow:transition on="recover" to="preencherDocumentos">
            <webflow:evaluate expression="dynamicFormAction.recoverDocumentosAnexados"/>
        </webflow:transition>
    </webflow:view-state>
    <webflow:action-state id="processarDocumentos">
        <webflow:evaluate expression="dynamicFormAction.uploadFiles">
            <webflow:attribute name="validatorMethod" value="validateMandatoryTipificacoes"/>
        </webflow:evaluate>
        <webflow:transition on="success" to="resumo"/>
        <webflow:transition on="error" to="preencherDocumentos"/>
        <webflow:transition on="dirs-nok" to="servicoindisponivel"/>
    </webflow:action-state>
    <webflow:action-state id="preencherAdicionarDocumentos">
        <webflow:evaluate expression="dynamicFormAction.uploadFiles"/>
        <webflow:transition on="success" to="preencherDocumentos"/>
        <webflow:transition on="error" to="preencherDocumentos"/>
        <webflow:transition on="dirs-nok" to="servicoindisponivel"/>
    </webflow:action-state>
    <webflow:action-state id="processback">
        <webflow:on-entry>
            <webflow:evaluate expression="dynamicFormAction.bind"/>
        </webflow:on-entry>
        <webflow:evaluate expression="dynamicFormAction.checkDocsInstrucao"/>
        <webflow:transition on="success" to="adicionarDocumentos"/>
        <webflow:transition on="jump_to" to="formScreen"/>
    </webflow:action-state>

    <!-- PRESUBMIT SCREEN -->
    <!--<webflow:view-state id="resumo" view="webflow.dynamic.resumoscreenwithfiles">-->
    <webflow:view-state id="resumo" view="agora.webflow.dynamic.resumoscreenwithfiles">
    <webflow:transition on="back" to="preencherDocumentosAjax">
        <webflow:evaluate expression="dynamicFormAction.bind"/>
    </webflow:transition>
    <webflow:transition on="next" to="save"/>
    <webflow:transition on="suspend" to="afterBindingDynamicValues">
        <webflow:set name="flowScope.isAjax" value="false"/>
    </webflow:transition>
    </webflow:view-state>
    <webflow:action-state id="suspender">
        <webflow:evaluate expression="dynamicFormAction.bindDynamicValues"/>
        <webflow:transition on="success" to="afterBindingDynamicValues"/>
    </webflow:action-state>
    <webflow:action-state id="afterBindingDynamicValues">
        <webflow:evaluate expression="dynamicFormAction.suspend"/>
        <webflow:transition on="${false == flowScope.isAjax}" to="quercontinuar"/>
        <webflow:transition on="${true ==flowScope.isAjax}" to="quercontinuarAjax"/>
    </webflow:action-state>
    <!--<webflow:view-state id="quercontinuarAjax" view="ipdms.webflow.quercontinuar.ajax">-->
    <webflow:view-state id="quercontinuarAjax" view="agora.webflow.quercontinuar.ajax">
        <webflow:transition on="sim" to="${flowScope.viewstatehistory.beforeLast}">
            <webflow:evaluate expression="dynamicFormAction.bind"/>
        </webflow:transition>
        <webflow:transition on="nao" to="cancelar"/>
    </webflow:view-state>
    <!--<webflow:view-state id="quercontinuar" view="ipdms.webflow.quercontinuar">-->
    <webflow:view-state id="quercontinuar" view="agora.webflow.quercontinuar">
        <webflow:transition on="sim" to="${flowScope.viewstatehistory.beforeLast}">
            <webflow:evaluate expression="dynamicFormAction.bind"/>
        </webflow:transition>
        <webflow:transition on="nao" to="cancelar"/>
    </webflow:view-state>

    <!-- SAVE -->
    <webflow:action-state id="save">
    <webflow:evaluate expression="dynamicFormAction.save"/>
    <webflow:transition on="success" to="relatorio"/>
    <webflow:transition on="save-error" to="save.error"/>
    </webflow:action-state>

    <!-- END SCREEN -->
    <!--<webflow:view-state id="relatorio" view="webflow.dynamic.endscreen">-->
    <webflow:view-state id="relatorio" view="agora.webflow.dynamic.endscreen">
    <webflow:transition on="next" to="concluir"/>
    </webflow:view-state>

    <!-- GLOBAL END STATES -->
    <webflow:end-state id="concluir" view="externalRedirect:${flowScope.relativeReferer}"/>
    <webflow:end-state id="cancelar" view="externalRedirect:${flowScope.relativeReferer}"/>
    <webflow:end-state id="save.error" view="ipdms.error.default.ajax"/>
    <webflow:global-transitions>
        <webflow:transition on="cancel" to="cancelar"/>
    </webflow:global-transitions>
</webflow:flow>