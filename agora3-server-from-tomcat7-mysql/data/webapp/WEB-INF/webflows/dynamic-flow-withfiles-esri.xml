<?xml version="1.0" encoding="UTF-8"?>

<flow xmlns="http://www.springframework.org/schema/webflow"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="http://www.springframework.org/schema/webflow
  						http://www.springframework.org/schema/webflow/spring-webflow-1.0.xsd">		

	<start-actions>
		<action bean="dynamicFormAction" method="setupForm" />
		<action bean="dynamicFormAction" method="preFillSessionValues" />
		<action bean="flowUtils" method="establishReferer" />		
	</start-actions>
  						
  	<start-state idref="formScreen" />

	<!-- DYNAMIC SCREEN FORM -->
	<view-state id="formScreen" view="webflow.dynamic.formscreen">
   		<transition on="next" to="processDynamicForm" />
   		<transition on="refreshDynamicValues" to="formScreenAjax">
   			<action bean="dynamicFormAction" method="refreshDynamicValues" />
   		</transition>
		<transition on="suspend" to="suspender" >
   			<set attribute="isAjax" value="false" scope="flow"></set>
   		</transition>
	</view-state>
	<view-state id="formScreenAjax" view="webflow.dynamic.formscreen.ajax">
   		<transition on="next" to="processDynamicForm" />
   		<transition on="refreshDynamicValues" to="formScreenAjax">
   			<action bean="dynamicFormAction" method="refreshDynamicValues" />
   		</transition>
   		<transition on="suspend" to="suspender">
   			<set attribute="isAjax" value="true" scope="flow"></set> 
 		</transition>
	</view-state>
	<action-state id="processDynamicForm">
		<entry-actions>
			<action bean="dynamicFormAction" method="bindDynamicValues" />
		</entry-actions>
		<action bean="dynamicFormAction" method="bindAndValidate">
			<attribute name="validatorMethod" value="validateDynamicForm" />
		</action>
		<transition on="success" to="verify_adicionarDocumentos_screen" />
		<transition on="error" to="formScreenAjax" />
	</action-state>
	<action-state id="verify_adicionarDocumentos_screen">
		<entry-actions>
			<action bean="dynamicFormAction" method="bind" />
		</entry-actions>		
		<action bean="dynamicFormAction" method="checkDocsInstrucao" />					
		<transition on="success" to="adicionarDocumentosAjax" />		
		<transition on="jump_to" to="preencherDocumentosAjax" />
	</action-state>
	
	<!-- Ecra adicionar documentos por item de conjunto -->
	<view-state id="adicionarDocumentos" view="webflow.dynamic.adddocumentobyitem">
		<transition on="back" to="formScreen">
			<action bean="dynamicFormAction" method="resetDocumentoFisico" />
			<action bean="dynamicFormAction" method="bind" />
		</transition>
		<transition on="next" to="uploadAdicionarDocumentos">
			<action bean="dynamicFormAction" method="resetDocumentoFisico" />
		</transition>
	</view-state>
	<view-state id="adicionarDocumentosAjax" view="webflow.dynamic.adddocumentobyitem.ajax">
		<transition on="back" to="formScreen">
			<action bean="dynamicFormAction" method="resetDocumentoFisico" />
			<action bean="dynamicFormAction" method="bind" />
		</transition>
		<transition on="next" to="uploadAdicionarDocumentos">
			<action bean="dynamicFormAction" method="resetDocumentoFisico" />
		</transition>
	</view-state>	
	<action-state id="uploadAdicionarDocumentos">
		<action bean="dynamicFormAction" method="uploadFilesOfItens">
			<attribute name="validatorMethod" value="validateMandatoryTipificacoesInItemFiles" />
		</action>
		<transition to="adicionarDocumentos" on="error" />
		<transition to="preencherDocumentos" on="success" />
	</action-state>
	
	<!-- Ecra de Anexar Documento -->
	<view-state id="preencherDocumentosAjax" view="webflow.dynamic.anexardocumentos.ajax">
		<transition on="back" to="processback" />			
   		<transition on="next" to="processarDocumentos" />
   		<transition on="add" to="preencherAdicionarDocumentos" />
   		<transition on="delete" to="preencherDocumentos">
   			<action bean="dynamicFormAction" method="deleteDocumentosAnexados" />
   		</transition>
   		<transition on="recover" to="preencherDocumentos">
   			<action bean="dynamicFormAction" method="recoverDocumentosAnexados" />
   		</transition>
	</view-state>
	<view-state id="preencherDocumentos" view="webflow.dynamic.anexardocumentos">
		<transition on="back" to="processback" />			
   		<transition on="next" to="processarDocumentos" />
   		<transition on="add" to="preencherAdicionarDocumentos" />
   		<transition on="delete" to="preencherDocumentos">
   			<action bean="dynamicFormAction" method="deleteDocumentosAnexados" />
   		</transition>
   		<transition on="recover" to="preencherDocumentos">
   			<action bean="dynamicFormAction" method="recoverDocumentosAnexados" />
   		</transition>
	</view-state>
	<action-state id="processarDocumentos">
		<action bean="dynamicFormAction" method="uploadFiles">
			<attribute name="validatorMethod" value="validateMandatoryTipificacoes" />
		</action>
		<transition on="success" to="integracaoEsri" />
		<transition on="error" to="preencherDocumentos" />
		<transition on="dirs-nok" to="servicoindisponivel" />
	</action-state>
	<action-state id="preencherAdicionarDocumentos">
		<action bean="dynamicFormAction" method="uploadFiles" />
		<transition on="success" to="preencherDocumentos" />
		<transition on="error" to="preencherDocumentos" />
		<transition on="dirs-nok" to="servicoindisponivel" />
	</action-state>
	<action-state id="processback">
		<entry-actions>
			<action bean="dynamicFormAction" method="bind" />
		</entry-actions>		
		<action bean="dynamicFormAction" method="checkDocsInstrucao" />					
		<transition on="success" to="adicionarDocumentos" />		
		<transition on="jump_to" to="formScreen" />
	</action-state>


	<!-- INTEGRACAO ESRI SCREEN -->
	<view-state id="integracaoEsri" view="webflow.dynamic.sig.esri">
		<entry-actions>
			<action bean="dynamicFormAction" method="generateSigId"/>
		</entry-actions>
		<transition on="back" to="preencherDocumentosAjax">
			<action bean="dynamicFormAction" method="bind" />
		</transition>
		<transition on="next" to="resumo" />
	</view-state>
	
	<!-- PRESUBMIT SCREEN -->
	<view-state id="resumo" view="webflow.dynamic.resumoscreenwithfiles">
		<transition on="back" to="adicionarDocumentosAjax">
			<action bean="dynamicFormAction" method="bind" />
		</transition>
		<transition on="next" to="save" />
				<transition on="suspend" to="afterBindingDynamicValues">
				<set attribute="isAjax" value="false" scope="flow"></set>
		</transition>
	</view-state>
	
	
	<action-state id="suspender">
			<action bean="dynamicFormAction" method="bindDynamicValues"  />
			<transition on="success" to="afterBindingDynamicValues" >				
			</transition>			
	</action-state>
	
	<action-state id="afterBindingDynamicValues">
		<action bean="dynamicFormAction" method="suspend"></action>
		
		<transition to="quercontinuar" on = "${false == flowScope.isAjax}" />
		
		<transition to="quercontinuarAjax" on = "${true ==flowScope.isAjax}"></transition>
	</action-state>
	
	<view-state id="quercontinuarAjax" view="ipdms.webflow.quercontinuar.ajax">
		<transition on="sim" to="${flowScope.viewstatehistory.beforeLast}">
			<action bean="dynamicFormAction" method="bind" />
		</transition>
		<transition on="nao" to="cancelar"/>
	</view-state>
	
	<view-state id="quercontinuar" view="ipdms.webflow.quercontinuar">
		<transition on="sim" to="${flowScope.viewstatehistory.beforeLast}">
			<action bean="dynamicFormAction" method="bind" />
		</transition>
		<transition on="nao" to="cancelar"/>
	</view-state>
	
	
	<!-- SAVE -->
	<action-state id="save">
		<action bean="dynamicFormAction" method="save"/>
		<transition on="success" to="relatorio"/>
		<transition on="save-error" to="save.error"/>
	</action-state>

	<!-- END SCREEN -->
	<view-state id="relatorio" view="webflow.dynamic.endscreen">
		<transition on="next" to="concluir" />
	</view-state>
	
	<!-- GLOBAL END STATES -->
	<end-state id="concluir" view="externalRedirect:${flowScope.relativeReferer}" />
	<end-state id="cancelar" view="externalRedirect:${flowScope.relativeReferer}" />
	<end-state id="save.error" view="ipdms.error.default.ajax" />
	
	<global-transitions>
		<transition on="cancel" to="cancelar" />
	</global-transitions>
</flow>
